PIXI.DisplayObject.prototype.enabled=!0,PIXI.DisplayObject.prototype.enable=function(){this.enabled=!0,this.visible=!0},PIXI.DisplayObject.prototype.disable=function(){this.enabled=!1,this.visible=!1},PIXI.DisplayObject.prototype.update=function(t){},PIXI.DisplayObject.prototype.zIndex=0,PIXI.Container.prototype.update=function(t){this.children.sort((t,e)=>t.zIndex-e.zIndex);for(const e of this.children)e.update(t)},Object.defineProperty(PIXI.DisplayObject.prototype,"scene",{get(){let t=this;for(;!(t instanceof Filament.Scene)&&t.parent;)t=t.parent;return t instanceof Filament.Scene?t:null},set(t){this.scene!==t&&t.addChild(this)}}),PIXI.Texture.prototype.crop=function(t,e,i,n){const s=1===arguments.length?t:new PIXI.Rectangle(t,e,i,n);return new PIXI.Texture(this.baseTexture,s)},PIXI.Sprite.prototype.crop=function(){this.texture=this.texture.crop(...arguments)},Filament.BLEND_MODES={},Filament.addBlendMode=function(t,e){const i=Filament.pixi.renderer.state.blendModes;Filament.BLEND_MODES[t]=i.length,i.push(e)},Filament.Enum=class{constructor(...t){for(const e of t)this[e]=e}},Filament.SCALE_MODE=new Filament.Enum("NORMAL","NEAREST","HYBRID"),Filament.settings={slug:"filament",width:320,height:240,tileSize:16,cellSize:24,scaleMode:Filament.SCALE_MODE.HYBRID,_maintainAspectRatio:1,get maintainAspectRatio(){return this._maintainAspectRatio<1?1/0:this._maintainAspectRatio},set maintainAspectRatio(t){this._maintainAspectRatio=t<1?1/0:t},_uiRes:0,get uiRes(){return this._uiRes>0?this._uiRes:Filament.scale},set uiRes(t){this._uiRes=t},language:"en"},Filament.configure=(t=>{Object.assign(Filament.settings,t)}),Filament.loadSettings=async function(){const t=await(await fetch(Filament.gameFile("settings.json"))).json();Filament.configure(t),Filament.determineScale();const e=document.body.style;e.setProperty("--uiRes",Filament.settings.uiRes),e.setProperty("--screen-width",Filament.settings.width),e.setProperty("--screen-height",Filament.settings.height),e.setProperty("--tileSize",Filament.settings.tileSize)},Object.defineProperties(Filament,{pixiScaleMode:{get:()=>Filament.settings.scaleMode===Filament.SCALE_MODE.NORMAL?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST}}),Filament.truncateNumber=(t=>{if(t<=99999)return t+"";let e=0;for(;t>9999&&e<5;)t/=1e3,++e;return Math.floor(t)+Filament.LARGE_NUMBER_ABBREVIATIONS[e]}),Filament.LARGE_NUMBER_ABBREVIATIONS=["","K","M","B","T","Q"],Filament.sleep=(t=>new Promise(e=>setTimeout(e,t))),Filament.minmax=((t,e,i)=>Math.max(t,Math.min(e,i))),Filament.round=((t,e=0,i="round")=>{const n=Math.pow(10,e);return Math[i](t*n)/n}),Filament.floor=((t,e)=>Filament.round(t,e,"floor")),Filament.ceil=((t,e)=>Filament.round(t,e,"ceil")),Filament.roundFactor=((t,e=1,i="round")=>Math[i](t/e)*e),Filament.floorFactor=((t,e)=>Filament.roundFactor(t,e,"floor")),Filament.ceilFactor=((t,e)=>Filament.roundFactor(t,e,"ceil")),Filament.arrayAdd=((t,e,i=t.length)=>!(t.indexOf(e)>=0)&&(t.splice(i,0,e),!0)),Filament.arrayRemove=((t,e)=>{const i=t.indexOf(e);return i>=0&&(t.splice(i,1),!0)}),Filament.arrayShuffle=(t=>{for(let e=t.length-1;e>0;--e){const i=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[i],t[i]=n}return t}),Filament.modulo=((t,e)=>(t%e+e)%e),Filament.assign=((t,...e)=>{for(const i of e)for(const e in i)e in t||(t[e]=i[e])}),Filament.mixin_object=((t,e)=>{Filament.assign(t,e),"function"==typeof e.implement&&e.implement.call(t)}),Filament.mixin=((t,e)=>{if(!(t instanceof Function))return Filament.mixin_object(t,e);t._mixins||(t._mixins=[]),t._mixins.push(e),Filament.assign(t.prototype,e),t.prototype.implement=Filament.implement.bind(this)}),Filament.implement=function(t,e){if(t&&e._mixins)for(const i of e._mixins)"function"==typeof i.implement&&i.implement.call(t)},Filament.untag=((t,...e)=>{if(!(t instanceof Array))return t;let i="";for(const n in t)i+=t[n]+(e[n]||"");return i}),Filament.html=((...t)=>{const e=Filament.untag(...t),i=document.createElement("div");return i.innerHTML=e,new Filament.NodeList(...i.childNodes)}),Filament.NodeList=class extends Array{mount(t){for(const e of this)t.append(e);return this}elements(){let t=[];for(const e of this)e instanceof Element&&t.push(e);return t}},Filament.createElement=((t,e)=>{let i=t.match(/^[^\s.#[\]]+/);if(!i)throw`Couldn't find tagname in string ${t}`;const n=document.createElement(i[0]);(i=t.match(/#([^\s.#[\]]+)/))&&(n.id=i[1]);let s=/\.([^\s.#[\]]+)/g;for(;i=s.exec(t);)n.classList.add(i[1]);for(s=/\[([^\s.#[\]=]+)=([^\s.#[\]=]+)\]/g;i=s.exec(t);)n.setAttribute(i[1],i[2]);return e&&n.append(e),n.mount=Filament.mountElement,n}),Filament.mountElement=function(t){if(this instanceof Element)return t.append(this),this};{const t={construct:()=>t};Filament.isConstructor=(e=>{try{return Boolean(new new Proxy(e,t))}catch(t){return!1}})}Filament.CoordMap=class{constructor(t=2,e=null,...i){this.dimensions=t,this.dfault=e,this.defaultArgs=i,this.data={},this.root=this}get(t,...e){return this.coords=[t,...e],this._get(t,...e)}_get(t,...e){return this.dimensions<=1?this._getValue(t):this._getSubDimension(t).get(...e)}_getValue(t){if(t in this.data)return this.data[t];if("function"==typeof this.dfault){let e;return e=Filament.isConstructor(this.dfault)?new this.dfault(...this.defaultArgs,...this.root.coords):this.dfault(...this.defaultArgs,...this.root.coords),this.data[t]=e}return this.dfault}_getSubDimension(t){return this.data[t]instanceof Filament.CoordMap||(this.data[t]=new Filament.CoordMap(this.dimensions-1,this.dfault,...this.defaultArgs),this.data[t].root=this.root),this.data[t]}set(t,...e){this.dimensions<=1?this.data[t]=e[0]:this._getSubDimension(t).set(...e)}unset(t,...e){if(this.dimensions<=1)return void delete this.data[t];const i=this._getSubDimension(t);i.unset(...e),0===Object.keys(i.data).length&&delete this.data[t]}has(t,...e){return this.dimensions<=1?t in this.data:t in this.data&&this._getSubDimension(t).has(...e)}},Filament.log=(t=>{console.log(t)}),Object.assign(Filament.log,{error(t){console.error(t)},warn(t){console.warn(t)}}),Filament.pixiCanvas=document.querySelector("#screen-game canvas"),Filament.parent=Filament.pixiCanvas.parentElement,Filament.ui_container=document.getElementById("ui-container"),Filament.pixi=new PIXI.Application({view:Filament.pixiCanvas,width:Filament.settings.width,height:Filament.settings.height,backgroundColor:136}),Filament.origin=new PIXI.Point(0,0),Filament.start=async function(){await Filament.loadSettings(),Filament.pixiContext=Filament.pixiCanvas.getContext("2d"),Filament.settings.scaleMode===Filament.SCALE_MODE.HYBRID&&(Filament.hybridCanvas=document.createElement("canvas"),Filament.hybridContext=Filament.hybridCanvas.getContext("2d"),Filament.hybridCanvas.id="hybrid-canvas",Filament.pixiCanvas.parentElement.appendChild(Filament.hybridCanvas),Filament.pixiCanvas.style.opacity=0),Filament.ui_container.style.setProperty("--width",Filament.settings.width*Filament.settings.uiRes),Filament.ui_container.style.setProperty("--height",Filament.settings.height*Filament.settings.uiRes),window.addEventListener("resize",Filament.resize),Filament.resize(),Filament.ticker=Filament.pixi.ticker.add(Filament.update,Filament),Filament.events.fireEvent("start");for(const t of Object.values(Filament.scenes))t.start()},Filament.update=(()=>{const t=Filament.ticker.elapsedMS/1e3;Filament.scene&&(Filament.scene.update(t),Filament.scene.updateUI(t)),Filament.hybridCanvas&&(Filament.pixi.render(),Filament.hybridContext.drawImage(Filament.pixiCanvas,0,0,Filament.pixiCanvas.width,Filament.pixiCanvas.height,0,0,Filament.hybridCanvas.width,Filament.hybridCanvas.height))}),Filament.roundScale=(t=>Math.round(t)||1),Filament.resize=(async()=>{if(Filament.electron){if(Filament._resize(),Filament.resizing)return;Filament.resizing=!0;for(let t=0;t<10;++t)Filament._resize(),await Filament.sleep(10);Filament.resizing=!1}else Filament._resize()}),Filament._resize=(()=>{let t=Filament.parent.offsetWidth/Filament.parent.offsetHeight,e=Filament.settings.width/Filament.settings.height;(t=Filament.minmax(e/Filament.settings.maintainAspectRatio,e*Filament.settings.maintainAspectRatio,t))>e?Filament.pixi.renderer.resize(Filament.settings.height*t,Filament.settings.height):Filament.pixi.renderer.resize(Filament.settings.width,Filament.settings.width/t);let i=Filament.determineScale();document.body.style.setProperty("--uiRes",Filament.settings.uiRes),Filament.pixiCanvas.style.width=Filament.pixiCanvas.width*i+"px",Filament.pixiCanvas.style.height=Filament.pixiCanvas.height*i+"px",Filament.hybridCanvas&&(Filament.hybridCanvas.width=Filament.settings.width*Filament.roundScale(i),Filament.hybridCanvas.height=Filament.settings.height*Filament.roundScale(i),Filament.hybridCanvas.style.width=Filament.pixiCanvas.style.width,Filament.hybridCanvas.style.height=Filament.pixiCanvas.style.height,Filament.hybridContext.imageSmoothingEnabled=!1),Filament.ui_container.style.setProperty("--scale",i/Filament.settings.uiRes),Filament.ui_container.style.setProperty("--left",Filament.parent.offsetWidth/2-Filament.ui_container.offsetWidth/2),Filament.ui_container.style.setProperty("--top",Filament.parent.offsetHeight/2-Filament.ui_container.offsetHeight/2),Filament.ui_container.style.setProperty("--width",Filament.pixiCanvas.width*Filament.settings.uiRes),Filament.ui_container.style.setProperty("--height",Filament.pixiCanvas.height*Filament.settings.uiRes),Filament.alignScene(),Filament.events.fireEvent("resize")}),Filament.determineScale=(()=>{let t=Filament.parent.offsetWidth/Filament.pixiCanvas.width,e=Filament.parent.offsetHeight/Filament.pixiCanvas.height,i=Math.min(t,e);return Filament.scale=i,document.body.style.setProperty("--scale",i),i}),Filament.alignScene=(()=>{Filament.scene.position.set(Math.round((Filament.pixiCanvas.width-Filament.settings.width)/2),Math.round((Filament.pixiCanvas.height-Filament.settings.height)/2))}),Filament.MixinEvents={implement(){this.events={}},getEventList(t,e){return t in this.events||!e||(this.events[t]=[]),this.events[t]},fireEvent(t,e={}){const i=this.getEventList(t,!1);if(i)for(const n of i){if(e.remove=Filament.MixinEvents.removeEvent.bind(this,t,n),n.context instanceof PIXI.DisplayObject){const t=n.context.scene;if(!t){e.remove();continue}if(t!==Filament.scene)continue}"function"==typeof n.callback&&n.callback.call(n.context,e)}},addEvent(t,e,i){const n={callback:e,context:i};return Filament.arrayAdd(this.getEventList(t,!0),n),n},removeEvent(t,e){const i=this.getEventList(t,!1);return!!i&&Filament.arrayRemove(i,e)}},Filament.MixinEventHandler={eventHandler(t,e){"function"==typeof this.fireEvent&&this.fireEvent(t,e)},addEventHandler(t,e=Filament.parent){const i=`${t}Handler`;this[i]=this.eventHandler.bind(this,t),e instanceof Object&&"addEventListener"in e&&e.addEventListener(t,this[i])}},Filament.events={},Filament.mixin_object(Filament.events,Filament.MixinEvents),Filament.MixinUtil={mount(t){return t.addChild(this),this},assign(t,e){return"object"==typeof arguments[0]?Object.assign(this,arguments[0]):this[t]=e,this}},Filament.mixin(PIXI.DisplayObject,Filament.MixinUtil),Filament.keyboard={keys:{},eventHandler(t,e){const i=this.getKey(e.code,!1);if(i){"function"==typeof i[t]&&i[t]();for(const n of i.keygroups)n.fireEvent(t,e)}},getKey(t,e){return t in this.keys||!e||(this.keys[t]=new Filament.Key(t)),this.keys[t]}},Filament.mixin_object(Filament.keyboard,Filament.MixinEventHandler),Filament.keyboard.addEventHandler("keydown"),Filament.keyboard.addEventHandler("keyup"),Filament.Key=class{constructor(t){this.name=t,this.isDown=!1,this.keygroups=[]}keydown(){this.isDown=!0}keyup(){this.isDown=!1}},Filament.keys={},Filament.KeyGroup=class{constructor(t,e=[]){this.name=t,Filament.keys[t]=this,this.keys=[];for(const t of e)this.addKey(t);this.implement(this,Filament.KeyGroup)}addKey(t){const e=Filament.keyboard.getKey(t,!0);Filament.arrayAdd(e.keygroups,this),Filament.arrayAdd(this.keys,e)}removeKey(t){const e=Filament.keyboard.getKey(t,!1);e&&(Filament.arrayRemove(e.keygroups,this),Filament.arrayRemove(this.keys,e))}get isDown(){for(const t in this.keys)if(t.isDown)return!0;return!1}},Filament.mixin(Filament.KeyGroup,Filament.MixinEvents),new Filament.KeyGroup("CONFIRM",["Enter","Space"]),new Filament.KeyGroup("CANCEL",["Escape"]),new Filament.KeyGroup("UP",["ArrowUp","KeyW"]),new Filament.KeyGroup("LEFT",["ArrowLeft","KeyA"]),new Filament.KeyGroup("DOWN",["ArrowDown","KeyS"]),new Filament.KeyGroup("RIGHT",["ArrowRight","KeyD"]),Filament.mouse={eventHandler(t,e){const i=Filament.pixiCanvas.getBoundingClientRect();e.canvasX=(e.clientX-i.x)/Filament.scale,e.canvasY=(e.clientY-i.y)/Filament.scale,e.worldX=e.canvasX-Filament.scene.position.x,e.worldY=e.canvasY-Filament.scene.position.y,this.fireEvent(t,e)}},Filament.mixin_object(Filament.mouse,Filament.MixinEvents),Filament.mixin_object(Filament.mouse,Filament.MixinEventHandler),Filament.mouse.addEventHandler("click"),Filament.mouse.addEventHandler("dblclick"),Filament.mouse.addEventHandler("mousedown"),Filament.mouse.addEventHandler("mouseup",window),Filament.mouse.addEventHandler("mousemove"),Filament.mouse.addEvent("mousedown",t=>{Filament.mouse.isDown=!0}),Filament.mouse.addEvent("mouseup",t=>{Filament.mouse.isDown=!1}),Filament.Cache=class{constructor(){this._cache={}}async requestImage(t,e="assets/images"){return await this.gameAsset(t,e,t=>(t.texture.baseTexture.scaleMode=Filament.pixiScaleMode,t.texture))}async requestAudio(t){}async requestJSON(t,e="data"){return await this.gameAsset(t,e,t=>t.data)}async requestCompressedJSON(t,e="data"){return await Filament.loadFile(Filament.path(e,t))}async requestTileset(t){if(`tileset${t}`in this._cache)return this._cache[`tileset${t}`];var e,i;try{e=await this.requestJSON(`tilesets/${t}.json`)}catch(i){e=await this.requestJSON("tilesets/default.json"),Filament.log.error(`Failed to load tileset data ${t}.`)}try{i=await this.requestImage(e.image,"assets/tilesets")}catch(t){i=await this.requestImage("default.png","assets/tilesets"),Filament.log.error(`Failed to load tileset image ${e.image}.`)}const n=new Filament.TileSet(i,e);return this._cache[`tileset${t}`]=n,n}async gameAsset(t,e,i){return e=Filament.path(e,t),await this.requestAsset(e,Filament.gameFile(e),i)}requestAsset(t,e,i){return new Promise((n,s)=>{this._cache[t]||(this._cache[t]=new Filament.AssetLoader(t,e,this)),this._cache[t]instanceof Filament.AssetLoader?this._cache[t].addRequest(n,s,i):n(i(this._cache[t]))})}},Filament.cache=new Filament.Cache,Filament.AssetLoader=class extends PIXI.loaders.Loader{constructor(t,e,i){super(),this.add(t,e),this._requests=[],this.load((e,n)=>{const s=n[t];for(const t of this._requests)s.error?t.reject(s.error):t.resolve(t.callback(s));s.error?delete i._cache[t]:i._cache[t]=s})}addRequest(t,e,i){this._requests.push(new Filament.AssetRequest(t,e,i))}},Filament.AssetRequest=class{constructor(t,e,i){this.resolve=t,this.reject=e,this.callback=i}},Filament.UI=class extends PIXI.Container{constructor(){super(),this.ui=document.createElement("div"),this.anchor=new PIXI.ObservablePoint(this._onAnchorUpdate,this),this.uiAccessor("id"),this.uiAccessor("className"),this.classList=this.ui.classList,this.style=this.ui.style,this.style.position="absolute"}mount(t){return t.addChild(this),this}mountUI(t){return(t instanceof Filament.UI?t.ui:t).append(this.ui),this}uiAccessor(t,e=t){Object.defineProperty(this,t,{get(){return this.ui[e]},set(t){this.ui[e]=t}})}enable(){super.enable(),this.setAttribute("data-enabled",!0)}disable(){super.disable(),this.setAttribute("data-enabled",!1)}destroy(){super.destroy(),this.ui.parentNode.removeChild(this.ui)}setAttribute(t,e){e=String(e),this.ui.getAttribute(t)!==e&&this.ui.setAttribute(t,e)}setProperty(t,e){e=String(e),this.ui.style.getPropertyValue(t)!==e&&this.ui.style.setProperty(t,e)}setAttributes(t){for(const e in t)this.setAttribute(e,t[e])}setProperties(t){for(const e in t)this.setProperty(e,t[e])}updateUI(t){this.setAttribute("data-visible",this.worldVisible),!this.ui.parentNode&&this.scene&&this.scene!==this&&this.mountUI(this.scene)}_onAnchorUpdate(){}},Filament.Battler=class{constructor(){this.stats={lethality:0,resilience:0,haste:0,spirit:0,luck:0}}},Filament.Sprite=class extends PIXI.Sprite{constructor(t){super(PIXI.Texture.EMPTY),this.loadTexture(t)}async loadTexture(t){this.texture=await Filament.cache.requestImage(t)}},Filament.scenes={},Filament.activeScene="home",Object.defineProperty(Filament,"scene",{get:()=>Filament.scenes[Filament.activeScene]||Filament.scenes.home,set(t){const e=Filament.activeScene;if(t in Filament.scenes)Filament.activeScene=t;else for(const e in Filament.scenes)if(t===Filament.scenes[e]){Filament.activeScene=e;break}if(Filament.activeScene!==e){for(const t in Filament.scenes){const e=Filament.scenes[t];Filament.activeScene===e.name?(e.enable(),e.enter()):e.enabled&&(e.disable(),e.leave())}Filament.alignScene()}}}),Filament.ui_container=document.getElementById("ui-container"),Filament.Scene=class extends Filament.UI{constructor(t){super(),this.mountUI(Filament.ui_container),this.mount(Filament.pixi.stage),Filament.scenes[t]=this,this.id="scene-"+t,this.classList.add("scene"),this.name=t,this.windows=[],this.setAttribute("data-visible",!1)}enable(){super.enable(),this.setAttribute("data-visible",!0)}disable(){super.disable(),this.setAttribute("data-visible",!1)}updateUI(t){super.updateUI(t);for(let e=this.windows.length-1;e>=0;--e)this.windows[e].updateUI(t)}start(){}enter(){}leave(){}},Filament.Window=class extends Filament.UI{constructor(){super(),this.classList.add("window"),this.ui_width=20,this.ui_height=20,this.minwidth=20,this.minheight=20,this.maxwidth=Filament.settings.width,this.maxheight=Filament.settings.height,this._hasFrame=!1,this._interactive=!1,this.movable=!1,this.resizable=!1,this.closable=!1,this.edgeSnap=!0,this.content=Filament.createElement("div.content").mount(this.ui),this.handle=Filament.createElement("div.handle").mount(this.ui),this.closeButton=Filament.createElement("div.closeButton","Ã—").mount(this.ui),this.closeButton.addEventListener("click",t=>{this.destroy()}),this.teletype=0,this.handle.addEventListener("mousedown",t=>{Filament.arrayRemove(this.scene.windows,this),Filament.arrayAdd(this.scene.windows,this),this.dragging=!0}),this.handle.addEventListener("mouseup",t=>{this.dragging=!1,this.finishDrag(t)}),this.contentObserver=new MutationObserver(()=>{this.resizable&&(this.content.style.width||this.content.style.height)&&(this.content.style.width="",this.content.style.height="",this.resizing=!0)}),this.contentObserver.observe(this.content,{attributes:!0,attributeFilter:["style"]})}mount(t){return super.mount(t),t.scene&&this.mountUI(this.scene),this}mountUI(t){return this.scene&&Filament.arrayRemove(this.scene.windows,this),super.mountUI(t),Filament.arrayAdd(t.windows,this),this}destroy(){this.scene&&Filament.arrayRemove(this.scene.windows,this),super.destroy(...arguments)}get width(){return this.ui_width}set width(t){this.ui_width=t}get height(){return this.ui_height}set height(t){this.ui_height=t}get interactive(){return this._interactive||this.movable||this.resizable||this.closable}set interactive(t){this._interactive=t}get hasFrame(){return this._hasFrame||this.movable||this.resizable||this.closable}set hasFrame(t){this._hasFrame=t}getBoundsUI(){const t=this.toGlobal(Filament.origin),e={};return e.width=Filament.round(this.width,2),e.height=Filament.round(this.height,2),e.left=Filament.round(t.x-this.anchor.x*e.width,2),e.top=Filament.round(t.y-this.anchor.y*e.height,2),this.edgeSnap&&(e.left=Filament.minmax(0,Filament.pixiCanvas.width-e.width,e.left),e.top=Filament.minmax(0,Filament.pixiCanvas.height-e.height,e.top)),e}updateUI(t){super.updateUI(t),this.resizable&&(this.width=Filament.minmax(this.minwidth,this.maxwidth,this.width),this.height=Filament.minmax(this.minheight,this.maxheight,this.height));let e=this.getBoundsUI(!0);const i=this.scene.windows.indexOf(this);this.setProperties({"--width":e.width,"--height":e.height,"--x":e.left,"--y":e.top,"--z":1e3*this.zIndex+i,"--alpha":this.worldAlpha}),this.setAttributes({"data-frame":this.hasFrame,"data-interactive":this.interactive,"data-movable":this.movable,"data-resizable":this.resizable,"data-closable":this.closable})}updateDrag(t){this.x+=t.movementX/Filament.scale,this.y+=t.movementY/Filament.scale}finishDrag(t){if(this.edgeSnap){const t=this.parent.toLocal(Filament.origin);this.x=Filament.minmax(t.x+this.width*this.anchor.x,t.x+Filament.pixiCanvas.width-this.width*(1-this.anchor.x),this.x),this.y=Filament.minmax(t.y+this.height*this.anchor.y,t.y+Filament.pixiCanvas.height-this.height*(1-this.anchor.y),this.y)}}updateResize(t){this.width=Math.min(Filament.settings.width-this.x,this.width+t.movementX/Filament.scale),this.height=Math.min(Filament.settings.height-this.y,this.height+t.movementY/Filament.scale),this.resizing=!1}get text(){return this.content.innerHTML}set text(t){}},window.addEventListener("mousemove",t=>{if(Filament.scene)for(const e of Filament.scene.windows)e.dragging&&e.updateDrag(t),e.resizing&&e.updateResize(t)}),window.addEventListener("mouseup",t=>{if(Filament.scene)for(const t of Filament.scene.windows)t.dragging=!1,t.finishDrag()}),new Filament.Scene("home"),Filament.scenes.home.start=function(){this.window=(new Filament.Window).mount(this),this.window.width=100,this.window.height=50,this.window.x=50,this.window.y=75,this.window.resizable=!0,this.window.movable=!0,this.window.closable=!0,this.window.content.innerHTML="Welcome to Filament!<br>\n\t<a href=\"javascript:void(Filament.scene='map');\">Map</a>",new Filament.Sprite("ebby.png").mount(this).assign({alpha:.6}),new Filament.Sprite("ebby.png").mount(this).assign({x:20})},Filament.scenes.home.update=function(){},new Filament.Scene("map"),Filament.scenes.map.start=function(){Filament.map=(new Filament.TileMap).mount(this)},Filament.scenes.map.update=function(t){Filament.Scene.prototype.update.call(this,t)},Filament.TileMap=class extends PIXI.Container{constructor(){super(),this.baseLayer=(new PIXI.Container).mount(this),this.actorLayer=(new PIXI.Container).mount(this),this.fringeLayer=(new PIXI.Container).mount(this),this.cells=new Filament.CoordMap(2,Filament.MapCell,this),Filament.editor.enabled&&(this.clone=(new Filament.TileSelection).mount(this),this.selection=(new Filament.TileSelection).mount(this),this.selector=new Filament.TileSelector(this).mount(this)),this.settings={name:"",cellSize:null}}get cellSize(){return this.settings.cellSize?this.settings.cellSize:Filament.settings.cellSize}mount(){super.mount(...arguments);const t=this.scene;this.clone.mountUI(t),this.selection.mountUI(t),this.selector.mountUI(t)}},Filament.createTileEraser=function(){Filament.tileEraser=new PIXI.Graphics,Filament.tileEraser.beginFill(0);const t=Filament.settings.tileSize;Filament.tileEraser.drawRect(0,0,t,t),Filament.tileEraser.endFill(),Filament.tileEraser.blendMode=Filament.BLEND_MODES.ERASE},Filament.getEraser=function(t,e){const i=Filament.settings.tileSize;return Filament.tileEraser.position.set(t*i,e*i),Filament.tileEraser},Filament.events.addEvent("start",()=>{Filament.addBlendMode("ERASE",[0,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA]),Filament.createTileEraser()}),Filament.TileSet=class{constructor(t,e){this.image=t,this.data=e,this.stamp=new PIXI.Sprite(t)}getStamp(t,e,i,n){const s=this.data.tileSize;return this.stamp.crop(t*s,e*s,s,s),this.stamp.position.set(i*s,n*s),this.stamp}getTile(t,e){let i=this.data.data[e];i||(i=this.data.data[e]=[]);let n=i[t];if(null==n&&(n={data:0}),"number"==typeof n)n={data:n};else if(n.passage)return n;return n.passage=15&n.data,n.opaque=n.data>>>4&1,n.layer=n.data>>>5&7,n.terrain=n.data>>>8,i[t]=n,n}},Filament.Tile=class{constructor(t,e,i){"object"==typeof t&&(e=t.x,i=t.y,t=t.ts),this.ts=t,this.x=e,this.y=i}equals(t){return this.ts===t.ts&&this.x===t.x&&this.y===t.y}static equalStacks(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(!Filament.Tile.prototype.equals.call(t[i],e[i]))return!1;return!0}async loadTileset(){this.tileset||(this.tileset=await Filament.cache.requestTileset(this.ts),this.tileData=tileset.getTile(this.x,this.y))}},Filament.TileSelection=class extends Filament.Window{constructor(){super(),this.classList.add("tileSelection"),this.minwidth=0,this.minheight=0,this.width=Filament.settings.tileSize,this.height=Filament.settings.tileSize,this.edgeSnap=!1,this.zIndex=0,this.box={ox:0,oy:0},Object.defineProperties(this.box,{x:this.boxAccessor("x"),y:this.boxAccessor("y"),width:this.boxAccessor("width"),height:this.boxAccessor("height")})}boxAccessor(t){const e=Filament.settings.tileSize;return{get:()=>this[t]/e,set:i=>this[t]=i*e}}},Filament.TileSelector=class extends Filament.TileSelection{constructor(t){super(),this.tilemap=t,this.classList.add("tileSelector"),this.rightclicked=!1,this.dragTool=null,Filament.mouse.addEvent("mousemove",this.mousemove,this),Filament.mouse.addEvent("mousedown",this.mousedown,this),Filament.mouse.addEvent("mouseup",this.mouseup,this)}update(t){super.update(t),this.calcBrushSize(),this.tilemap.selection.visible=!!this.dragTool,this.tilemap.clone.visible=Filament.editor.clone}mousemove(t){this.box.x=Math.floor(t.worldX/Filament.settings.tileSize),this.box.y=Math.floor(t.worldY/Filament.settings.tileSize),Filament.mouse.isDown&&this.useTool(),this.dragTool&&this.dragSelection(this.tilemap.selection.box,this.box.x,this.box.y)}dragSelection(t,e,i){t.x=t.ox,t.y=t.oy,t.width=e-t.ox,t.width<0&&(t.x=t.ox+t.width,t.width*=-1),t.height=i-t.oy,t.height<0&&(t.y=t.oy+t.height,t.height*=-1),t.width+=1,t.height+=1}mousedown(t){this.dragTool=null,this.rightclicked=t.button>0,this.useTool()}mouseup(t){if(this.dragTool){switch(this.dragTool){case Filament.PLACEMENT_MODE.RECT:this.tool_RECT();break;case Filament.PLACEMENT_MODE.CLEARRECT:this.tool_CLEARRECT();break;case Filament.PLACEMENT_MODE.CLONE:this.tool_CLONE()}this.dragTool=null}t.button>0&&(this.rightclicked=!1)}getTool(){return this.rightclicked?Filament.editor.rightTool:Filament.editor.leftTool}useTool(){const t=this.getTool();switch(t){case Filament.PLACEMENT_MODE.PEN:return this.tool_PEN();case Filament.PLACEMENT_MODE.ERASE:return this.tool_ERASE();case Filament.PLACEMENT_MODE.FILL:return this.tool_FILL();case Filament.PLACEMENT_MODE.RECT:case Filament.PLACEMENT_MODE.CLEARRECT:case Filament.PLACEMENT_MODE.CLONE:return this.startDrag(t)}}startDrag(t){this.dragTool||(this.dragTool=t,this.tilemap.selection.box.ox=this.box.x,this.tilemap.selection.box.oy=this.box.y,this.dragSelection(this.tilemap.selection.box,this.box.x,this.box.y))}async tool_PEN(){const t=await this.getSelectedTiles();for(let e=0;e<t.length;++e)for(let i=0;i<t[e].length;++i){const n=t[e][i];await this.setTile(n,this.box.x+e,this.box.y+i)}}async tool_ERASE(){await this.eraseTile(this.box.x,this.box.y)}async tool_FILL(){const t=this.box.x,e=this.box.y,i=await this.getSelectedTiles();let{cell:n,x:s,y:a,stack:l}=await this.getCellTile(t,e);l=Array.from(l);const o=[];let r=0;const h=async(m,c)=>{if(m<0||m>=this.tilemap.cellSize||c<0||c>=this.tilemap.cellSize)return;const d=await n.getTileStack(m,c);if(!o.includes(d)&&Filament.Tile.equalStacks(d,l)){o.push(d);const n=i[Filament.modulo(m-s,i.length)],l=n[Filament.modulo(c-a,n.length)];this.setTile(l,t+m-s,e+c-a),++r%10==0&&await Filament.sleep(0);const u=[[m+1,c],[m,c+1],[m-1,c],[m,c-1]].sort((t,e)=>Math.pow(t[0]-s,2)+Math.pow(t[1]-a,2)-(Math.pow(e[0]-s,2)+Math.pow(e[1]-a,2)));for(const t of u)await h(...t)}};await h(s,a)}async tool_RECT(){const t=await this.getSelectedTiles(),e=this.tilemap.selection.box;for(let i=e.x;i<e.x+e.width;++i)for(let n=e.y;n<e.y+e.height;++n){const s=t[Filament.modulo(i-e.x,t.length)],a=s[Filament.modulo(n-e.y,s.length)];await this.setTile(a,i,n)}}async tool_CLEARRECT(){const t=this.tilemap.selection.box;for(let e=t.x;e<t.x+t.width;++e)for(let i=t.y;i<t.y+t.height;++i)await this.eraseTile(e,i)}tool_CLONE(){const t=this.tilemap.clone.box,e=this.tilemap.selection.box;t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,Filament.editor.clone=!0}calcBrushSize(){this.getTool()===Filament.PLACEMENT_MODE.PEN?Filament.editor.clone?(this.box.width=this.tilemap.clone.box.width,this.box.height=this.tilemap.clone.box.height):(this.box.width=Filament.editor.tileBox.width,this.box.height=Filament.editor.tileBox.height):this.box.width=this.box.height=1}async getSelectedTiles(){const t=[];if(Filament.editor.clone){const e=this.tilemap.clone.box;for(let i=e.x;i<e.x+e.width;++i){const n=[];t.push(n);for(let t=e.y;t<e.y+e.height;++t){const{stack:e}=await this.getCellTile(i,t);n.push(Array.from(e))}}return t}const e=Filament.editor.tileBox;for(let i=e.x;i<e.x+e.width;++i){const n=[];t.push(n);for(let t=e.y;t<e.y+e.height;++t)n.push(new Filament.Tile(Filament.editor.tilesetId,i,t))}return t}async setTile(t,e,i){const{cell:n,x:s,y:a,stack:l}=await this.getCellTile(e,i);if(t instanceof Filament.Tile)for(let e=0;e<l.length;++e){const i=l[e];if(i&&t.equals(i)){if(e===l.length-1)return;Filament.arrayRemove(l,i);break}}t instanceof Array?(l.length=0,l.push(...t)):Filament.arrayAdd(l,t),n.clearTile(s,a),await n.loadTileStack(s,a,l),n.empty&&(n.empty=!1)}async eraseTile(t,e){const{cell:i,x:n,y:s,stack:a}=await this.getCellTile(t,e);i.clearTile(n,s),a.length=0}async getCellTile(t,e){const i=Math.floor(t/this.tilemap.cellSize),n=Math.floor(e/this.tilemap.cellSize),s=this.tilemap.cells.get(i,n),a=Filament.modulo(t,this.tilemap.cellSize),l=Filament.modulo(e,this.tilemap.cellSize),o=await s.getTileStack(a,l);return{cell:s,x:a,y:l,stack:o}}},Filament.PLACEMENT_MODE=new Filament.Enum("PEN","ERASE","FILL","RECT","CLEARRECT","CLONE"),Object.assign(Filament.editor,{leftTool:Filament.PLACEMENT_MODE.PEN,rightTool:Filament.PLACEMENT_MODE.ERASE,tilesetId:0,tileBox:{x:0,y:0,width:1,height:1,ox:0,oy:0},clone:!1}),Filament.MapCell=class{constructor(t,e,i){this.x=e,this.y=i,this.tilemap=t,this.baseLayer=new Filament.MapCellLayer(t,e,i),this.fringeLayer=new Filament.MapCellLayer(t,e,i),t.baseLayer.addChild(this.baseLayer),t.fringeLayer.addChild(this.fringeLayer),this.lastTileset=0,this.loaded=!1,this.loadPromises=[],this.load(),Filament.editor.enabled&&(this.grid=new Filament.MapCellGrid(t.cellSize).mount(this.fringeLayer))}waitForLoad(){return new Promise((t,e)=>{this.loaded?t():this.loadPromises.push({resolve:t,reject:e})})}finishLoading(t=!0){this.loaded=!0;for(const e of this.loadPromises)t?e.resolve():e.reject()}async getTileStack(t,e){await this.waitForLoad();const i=t+e*this.tilemap.cellSize;return null==this.data[i]?this.data[i]=[]:this.data[i]instanceof Array||(this.data[i]=[this.data[i]]),this.data[i]}async load(){this.empty=!0,this.data=[],this.actors=[],await this.finishLoading(!0);for(let t=0;t<this.tilemap.cellSize;++t)for(let e=0;e<this.tilemap.cellSize;++e)await this.loadTileStack(e,t)}async loadTileStack(t,e,i){i||(i=await this.getTileStack(t,e));for(const n of i)await this.loadTile(n,t,e)}async loadTile(t,e,i){if(!t)return;const n="ts"in t?t.ts:this.lastTileset;n!==this.lastTileset&&(this.lastTileset=n);const s=t.x,a=t.y,l=await Filament.cache.requestTileset(n);switch(l.getTile(s,a).layer){case 0:this.baseLayer.drawTile(l,s,a,e,i)}}clearTile(t,e){this.baseLayer.clearTile(t,e),this.fringeLayer.clearTile(t,e)}unload(){this.baseLayer.destroy(),this.fringeLayer.destroy()}async saveToFile(){}async loadToFile(){}},Filament.MapCellGrid=class extends Filament.Window{constructor(t){super(),this.classList.add("mapCell-grid"),this.width=Filament.settings.tileSize*t,this.height=Filament.settings.tileSize*t,this.edgeSnap=!1,this.zIndex=-1}},Filament.MapCellLayer=class extends PIXI.Sprite{constructor(t,e,i){super(new Filament.MapCellTexture(t)),this.tilemap=t,this.x=e*Filament.settings.tileSize*this.tilemap.cellSize,this.y=i*Filament.settings.tileSize*this.tilemap.cellSize}destroy(){super.destroy(...arguments),this.texture.destroy()}drawTile(t,e,i,n,s){const a=t.getStamp(e,i,n,s);Filament.pixi.renderer.render(a,this.texture,!1)}clearTile(t,e){const i=Filament.getEraser(t,e);Filament.pixi.renderer.render(i,this.texture,!1)}},Filament.MapCellTexture=class extends PIXI.RenderTexture{constructor(t){super(new PIXI.BaseRenderTexture(Filament.settings.tileSize*t.cellSize,Filament.settings.tileSize*t.cellSize,Filament.pixiScaleMode)),this.tilemap=t}};
//# sourceMappingURL=engine.js.map
